---
title: "Adults and preschoolers flexibly adapt to noisy linguistic input"
author: "Daniel Yurovsky, Sarah Case, & Michael C. Frank"
date: "September 17, 2015"
output:
  html_document:
  highlight: tango
theme: spacelab
---
```{r setup, include=FALSE}
library(knitr)
options(scipen = 1, digits = 3)
opts_chunk$set(message=FALSE, warning=FALSE)
```

```{r, cache = FALSE, include = FALSE}
library(dplyr)
library(langcog)
library(tidyr)
library(magrittr)
library(lme4)
library(jsonlite)
library(dplyr)
library(tidyr)
library(ggplot2)
library(readr)
library(jsonlite)
library(compute.es)

colors <- c("#e41a1c", "#377eb8", "#4daf4a")
```

```{r tab_func, include = FALSE} 
kable_table <- function(lmer_results, predictors) {
  
  table <- as.data.frame(summary(lmer_results)$coef) %>%
    mutate(Predictor = predictors) %>%
    rowwise() %>%
    mutate(stars = get_stars(`Pr(>|z|)`)) %>%
    ungroup() %>%
    mutate(`Pr(>|z|)` = sprintf("%.3f", `Pr(>|z|)`)) %>%
    mutate(`Pr(>|z|)` = ifelse(`Pr(>|z|)` == "0.000", "< .001", `Pr(>|z|)`)) %>%
    select(Predictor, Estimate, `Std. Error`, `z value`, `Pr(>|z|)`, stars) %>%
    rename(`$z$ value` = `z value`,
           `$p$ value` = `Pr(>|z|)`)
  
  rownames(table) <- NULL
  names(table)[6] <- ""
  
  kable(table)
}
```

<h3> Experiment 1 </h3>

<h1> Load data </h1>
```{r load_exp1, cache=FALSE}
exp1_child_data <- read_csv("data/exp1_child.csv")
exp1_adult_data <- read_csv("data/exp1_adult.csv")

exp1_data <- bind_rows(exp1_child_data,exp1_adult_data) %>%
  mutate(response = factor(response, levels = c("Implausible", "Plausible")))
```

Munge experiment data
```{r munge_exp1}
child_demo_data <- exp1_child_data %>%
  distinct(subject) %>%
  group_by(condition) %>%
  summarise(n = n(),
            num_girls = sum(sex == "female"),
            min_age = min(age),
            mean_age = mean(age),
            max_age = max(age))

adult_demo_data <- exp1_adult_data %>%
  distinct(subject) %>%
  group_by(condition) %>%
  summarise(n = n())

exp1_group_data <- exp1_data %>%
  mutate(response = as.numeric(response) - 1) %>%
  group_by(group,condition,trial_type) %>%
  multi_boot_standard("response", na.rm = T)

kable(child_demo_data,
      col.names = c("Speaker Condition", "Num Participants",
                    "Num Girls","Min Age","Mean Age","Max. Age"),
      caption = "Child demographic data")

kable(adult_demo_data,
      col.names = c("Speaker Condition", "Num Participants"),
      caption = "Adult demographic data")
```

<h1> Analyze exposure trials </h1>
```{r exp1_exposure}
exp1_exposure_chance_lm <- glmer(response ~ 0 + group : condition + (1|word) + (1|subject), 
                          family = "binomial",
                          data = filter(exp1_data,trial_type == "Exposure"))

kable_table(exp1_exposure_chance_lm, c("Adults, Implausible", 
                                       "Children, Implausible", 
                                       "Adults, Plausible", 
                                       "Children, Plausible"))

exp1_exposure_lm <- glmer(response ~ group * condition + (1|word) + (1|subject), 
                          family = "binomial",
                          data = filter(exp1_data,trial_type == "Exposure"))
kable_table(exp1_exposure_lm, c("Intercept", "Children", "Plausible", 
                                "Children x Plausible"))
```

```{r exp1_exposure_plots, fig.width=6, fig.height=4}
#Exposure Trials
ggplot(filter(exp1_group_data,trial_type == "Exposure"), 
       aes(x=condition, y=mean, fill=group)) +
  facet_grid(. ~ group) +
  geom_bar(stat="identity",position=position_dodge(1))+
  geom_linerange(aes(ymin = ci_lower,
                      ymax = ci_upper),
                  size = .8,
                  show_guide = FALSE,
                 position=position_dodge(1)) +
  scale_fill_manual(values = colors) +
  geom_hline(aes(yintercept=.5),lty=2)+
  theme_bw(base_size=14) +
  theme(legend.position="none", panel.grid=element_blank()) +
  scale_x_discrete(name = "\nSpeaker Condition")+
  scale_y_continuous(name = "Proportion Choosing Plausible",
                     limits=c(0,1))
```

<h1> Analyze Test trials </h1>
```{r exp1_test}
exp1_test_lm <- glmer(response ~ group * condition + (1|word) + (1|subject), 
                          family = "binomial",
                          data = filter(exp1_data,trial_type == "Test"))
kable_table(exp1_test_lm, c("Intercept", "Children", "Plausible", 
                                "Children x Plausible"))

exp1_es <- exp1_data %>%
  filter(trial_type == "Test") %>%
  mutate(response = as.numeric(response) - 1) %>%
  group_by(group, condition, subject) %>%
  summarise(response = mean(response)) %>%
  summarise(mean = mean(response),
            sd = sd(response),
            n = n()) %>%
  group_by(group) %>%
  summarise(d = mes(mean[2],mean[1],sd[2],sd[1],n[2],n[1], verbose = FALSE)$d)

kable(exp1_es, caption = "Effect sizes for adults and children", 
      column.names = c("group", "Cohen's $d$"))

```

```{r exp1_test_plots, fig.width=6,fig.height=4}
#Test Trials
#quartz(width=6,height=4)
ggplot(filter(exp1_group_data,trial_type == "Test"), 
       aes(x=condition, y=mean, fill=group)) +
  facet_grid(. ~ group) +
  geom_bar(stat="identity",position=position_dodge(1))+
  geom_linerange(aes(ymin = ci_lower,
                      ymax = ci_upper),
                  size = .8,
                  show_guide = FALSE,
                 position=position_dodge(1)) +
  scale_fill_manual(values = colors) +
  geom_hline(aes(yintercept=.5),lty=2)+
  theme_bw(base_size=14) +
  theme(legend.position="none", panel.grid=element_blank()) +
  scale_x_discrete(name = "\nSpeaker Condition")+
  scale_y_continuous(name = "Proportion Choosing Plausible",
                     limits=c(0,1))
```

***

<h3> Experiment 2 </h3>

Load 2 data
```{r load_exp2, cache=FALSE}
exp2_child_data <- read_csv("data/exp2_child.csv") %>%
  mutate(response = factor(response, levels = c("Implausible", "Plausible")),
         condition = factor(condition, levels = c("Implausible", "Plausible", "Control"),
                            labels = c("Implausible", "Plausible", "Implausible (Control)")))
```

Munge experiment 2 data
```{r munge_exp2}
exp2_demo_data <- exp2_child_data %>%
  distinct(subject) %>%
  group_by(condition, noise) %>%
  summarise(n = n(),
            num_girls = sum(sex == "female", na.rm = T),
            min_age = min(age),
            mean_age = mean(age),
            max_age = max(age))

kable(exp2_demo_data,
      col.names = c("Speaker Condition", "Noise Level", "Num Participants",
                    "Num Girls","Min Age","Mean Age","Max. Age"))


exp2_group_data <- exp2_child_data %>%
  mutate(response = as.numeric(response)-1) %>%
  group_by(group,condition,noise,trial_type) %>%
  multi_boot_standard("response", na.rm = T)
```



Analyze exposure and test trials
```{r exp2_exposure}
exp2_exposure_chance_lm <- glmer(response ~ 0 + noise:condition + 
                                   (1|word) + (1|subject), family = "binomial",
                          data = filter(exp2_child_data,trial_type == "Exposure"))

kable_table(exp2_exposure_chance_lm, c("No Noise, Implausible", 
                                       "Noisy, Implausible", 
                                       "No Noise, Plausible", 
                                       "Noisy, Plausible",
                                       "Noisy, Implausible (Control)"))

exp2_exposure_lm <- glmer(response ~ condition * noise + (1|word) + (1|subject), 
                          family = "binomial",
                          data = filter(exp2_child_data,trial_type == "Exposure"))

kable_table(exp2_exposure_lm, c("Intercept", 
                                       "Plausible", 
                                       "Implausible (Control)", 
                                       "Noisy",
                                       "Plausible x Noisy"))


control_data <- exp2_child_data %>%
  filter(trial_type == "Test", noise == "Noisy") %>%
  mutate(condition = factor(condition, levels = c("Plausible", "Implausible", 
                                                  "Implausible (Control)")))
  

exp2_control_lm <-  glmer(response ~ condition + (1|word) + (1|subject), 
                          family = "binomial",
                          data = control_data)

kable_table(exp2_control_lm, c("Intercept", 
                               "Implausible", 
                               "Implausible (Control)"))



exp2_test_lm <- glmer(response ~ noise * condition + (1|word) + (1|subject), 
                      family = "binomial",
                      data = filter(exp2_child_data,trial_type == "Test",
                                    condition != "Implausible (Control)"))

kable_table(exp2_test_lm, c("Intercept", 
                            "Noisy", 
                            "Plausible",
                            "Noisy x Plausible"))
```

```{r exp2_plots, fig.width=7.5,fig.height=4}
#Exposure Trials
ggplot(filter(exp2_group_data,trial_type == "Exposure"), 
       aes(x=condition, y=mean, fill=group)) +
  facet_grid(. ~ noise) +
  geom_bar(stat="identity",position=position_dodge(1))+
  geom_linerange(aes(ymin = ci_lower,
                      ymax = ci_upper),
                  size = .8,
                  show_guide = FALSE,
                 position=position_dodge(1)) +
  scale_fill_manual(values = colors[2:3]) +
  geom_hline(aes(yintercept=.5),lty=2)+
  theme_bw(base_size=14) +
  theme(legend.position="none", panel.grid=element_blank()) +
  scale_x_discrete(name = "\nSpeaker Condition")+
  scale_y_continuous(name = "Proportion Choosing Plausible",
                     limits=c(0,1))

#Test Trials
plotting_test_data <- filter(exp2_group_data,trial_type == "Test") %>%
  mutate(width = ifelse(condition == "Implausible (Control)", .4, .9)) %>%
  mutate(test_type = ifelse(condition == "Implausible (Control)", 
                            "Plausible", "Implausible"))

#quartz(width=7.5,height=4)
ggplot(plotting_test_data, 
       aes(x=noise, y=mean, fill=test_type)) +
  facet_grid(. ~ condition, scales = "free_x") +
  geom_bar(aes(width = width),
           stat="identity", position=position_dodge(1))+
  geom_linerange(aes(ymin = ci_lower,
                      ymax = ci_upper),
                  size = .8,
                  show_guide = FALSE,
                 position=position_dodge(1)) +
  scale_fill_manual(values = colors[2:3]) +
  geom_hline(aes(yintercept=.5),lty=2)+
  theme_bw(base_size=14) +
  theme(legend.position="none", panel.grid=element_blank()) +
  scale_x_discrete(name = "\nNoise Level")+
  scale_y_continuous(name = "Proportion Choosing Plausible",
                     limits=c(0,1))
```

